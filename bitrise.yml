---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: flutter

trigger_map:
- push_branch: main
  workflow: android_firebase
- pull_request_source_branch: "*"
  workflow: android_firebase

# ============================================
# WORKFLOWS
# ============================================
workflows:
  
  # ------------------------------------------
  # ANDROID BUILD + FIREBASE APP DISTRIBUTION
  # ------------------------------------------
  android_firebase:
    description: |
      Build Android APK Ñ‚Ğ° deploy Ğ½Ğ° Firebase App Distribution.
      Ğ¦ĞµĞ¹ workflow Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑ”:
      1. ĞšĞ»Ğ¾Ğ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ñ–Ñ
      2. Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Flutter SDK
      3. ĞĞ½Ğ°Ğ»Ñ–Ğ· ĞºĞ¾Ğ´Ñƒ (flutter analyze)
      4. Build Release APK
      5. Upload Ğ½Ğ° Firebase App Distribution
    
    steps:
    
    # ========== STEP 1: Activate SSH Key ==========
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
        title: Activate SSH key for Git
    
    # ========== STEP 2: Clone Repository ==========
    - git-clone@8:
        title: Clone repository
    
    # ========== STEP 3: Install Flutter ==========
    - flutter-installer@0:
        title: Install Flutter SDK
        inputs:
        - version: stable
        - is_update: 'false'
    
    # ========== STEP 4: Restore Dart Cache ==========
    - restore-dart-cache@2:
        title: Restore Dart packages cache
    
    # ========== STEP 5: Flutter Pub Get ==========
    - script@1:
        title: Flutter packages get
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ“¦ Installing Flutter dependencies..."
            flutter pub get
            
            echo "âœ… Dependencies installed successfully"
    
    # ========== STEP 6: Flutter Analyze ==========
    - script@1:
        title: Flutter analyze (code quality check)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ” Running Flutter analyze..."
            flutter analyze --no-fatal-infos || true
            
            echo "âœ… Code analysis completed"
    
    # ========== STEP 7: Save Dart Cache ==========
    - save-dart-cache@1:
        title: Save Dart packages cache
    
    # ========== STEP 8: Build Android APK ==========
    - script@1:
        title: Build Android APK (Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ”¨ Building Flutter Android APK in RELEASE mode..."
            echo "Project: Quote Gallery"
            echo "Branch: $BITRISE_GIT_BRANCH"
            echo "Build Number: $BITRISE_BUILD_NUMBER"
            
            # Build release APK
            flutter build apk --release
            
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
            
            if [ -f "$APK_PATH" ]; then
                echo "âœ… APK built successfully!"
                echo "ğŸ“ Path: $APK_PATH"
                ls -lh "$APK_PATH"
                
                # Export path for Firebase step
                envman add --key ANDROID_APK_PATH --value "$BITRISE_SOURCE_DIR/$APK_PATH"
                
                # Copy to deploy directory with proper name
                cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/QuoteGallery-$BITRISE_BUILD_NUMBER.apk"
                echo "âœ… APK copied to artifacts as QuoteGallery-$BITRISE_BUILD_NUMBER.apk"
            else
                echo "âŒ APK not found at expected path!"
                echo "Searching for APK files..."
                find . -name "*.apk" -type f
                exit 1
            fi
    
    # ========== STEP 9: Verify Firebase Configuration ==========
    - script@1:
        title: Verify Firebase configuration
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ” Verifying Firebase configuration..."
            echo "======================================="
            echo "App ID: $FIREBASE_APP_ID_ANDROID"
            echo "APK Path: $ANDROID_APK_PATH"
            echo "======================================="
            
            if [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
                echo "âŒ ERROR: FIREBASE_APP_ID_ANDROID is not set!"
                echo ""
                echo "ğŸ“‹ To fix this, add the following Secret in Bitrise:"
                echo "   Key: FIREBASE_APP_ID_ANDROID"
                echo "   Value: Your Firebase Android App ID (e.g., 1:xxxxx:android:...)"
                echo ""
                echo "You can find this in Firebase Console > Project Settings > Your apps"
                exit 1
            fi
            
            if [ -z "$FIREBASE_TOKEN" ]; then
                echo "âŒ ERROR: FIREBASE_TOKEN is not set!"
                echo ""
                echo "ğŸ“‹ To generate a token, run locally:"
                echo "   firebase login:ci"
                echo ""
                echo "Then add the token as a Secret in Bitrise:"
                echo "   Key: FIREBASE_TOKEN"
                echo "   Value: <your-token>"
                exit 1
            fi
            
            if [ ! -f "$ANDROID_APK_PATH" ]; then
                echo "âŒ ERROR: APK file not found at $ANDROID_APK_PATH"
                exit 1
            fi
            
            echo "âœ… Firebase configuration verified successfully"
    
    # ========== STEP 10: Firebase App Distribution ==========
    - script@1:
        title: Deploy to Firebase App Distribution
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ”¥ Uploading to Firebase App Distribution..."
            echo "============================================"
            echo "ğŸ“± App: Quote Gallery"
            echo "ğŸ“¦ APK: $ANDROID_APK_PATH"
            echo "ğŸ”‘ App ID: $FIREBASE_APP_ID_ANDROID"
            echo "ğŸŒ¿ Branch: $BITRISE_GIT_BRANCH"
            echo "ğŸ”¢ Build: #$BITRISE_BUILD_NUMBER"
            echo "============================================"
            
            # Install Firebase CLI
            echo "ğŸ“¥ Installing Firebase CLI..."
            npm install -g firebase-tools
            firebase --version
            
            # Create release notes
            RELEASE_NOTES="Quote Gallery Build #$BITRISE_BUILD_NUMBER
            
            Branch: $BITRISE_GIT_BRANCH
            Commit: ${GIT_CLONE_COMMIT_HASH:0:8}
            Date: $(date '+%Y-%m-%d %H:%M:%S')
            
            Changes: $GIT_CLONE_COMMIT_MESSAGE_SUBJECT"
            
            echo "ğŸ“ Release notes:"
            echo "$RELEASE_NOTES"
            echo ""
            
            # Upload to Firebase App Distribution
            echo "ğŸ“¤ Starting upload..."
            firebase appdistribution:distribute "$ANDROID_APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "$RELEASE_NOTES"
            
            if [ $? -eq 0 ]; then
                echo ""
                echo "âœ… Successfully uploaded to Firebase App Distribution!"
                echo "ğŸ“§ Testers in 'testers' group will receive an email notification"
                echo ""
                echo "ğŸ”— Check Firebase Console for the release:"
                echo "   https://console.firebase.google.com/project/_/appdistribution"
            else
                echo "âŒ Firebase upload failed!"
                exit 1
            fi
    
    # ========== STEP 11: Create Installation Instructions ==========
    - script@1:
        title: Create installation instructions
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cat > "$BITRISE_DEPLOY_DIR/README.txt" << EOF
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘              ğŸ’¬ Quote Gallery - Build Info                   â•‘
            â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
            â•‘                                                              â•‘
            â•‘  ğŸ“¦ APK File: QuoteGallery-$BITRISE_BUILD_NUMBER.apk                        â•‘
            â•‘  ğŸŒ¿ Branch: $BITRISE_GIT_BRANCH                                       â•‘
            â•‘  ğŸ”¢ Build Number: $BITRISE_BUILD_NUMBER                                â•‘
            â•‘  ğŸ“… Build Date: $(date '+%Y-%m-%d %H:%M:%S')                     â•‘
            â•‘                                                              â•‘
            â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
            â•‘                    ğŸ“± INSTALLATION OPTIONS                   â•‘
            â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
            â•‘                                                              â•‘
            â•‘  OPTION 1: Firebase App Distribution (Recommended)           â•‘
            â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
            â•‘  1. Check your email for the Firebase invitation             â•‘
            â•‘  2. Install "Firebase App Tester" from Play Store            â•‘
            â•‘  3. Open the app and sign in                                 â•‘
            â•‘  4. Download and install the latest build                    â•‘
            â•‘                                                              â•‘
            â•‘  OPTION 2: Direct APK Install                                â•‘
            â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
            â•‘  1. Download QuoteGallery-$BITRISE_BUILD_NUMBER.apk                         â•‘
            â•‘  2. On Android: Settings > Security > Unknown sources ON     â•‘
            â•‘  3. Open the APK file and tap "Install"                      â•‘
            â•‘                                                              â•‘
            â•‘  OPTION 3: ADB Install (Developers)                          â•‘
            â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
            â•‘  adb install QuoteGallery-$BITRISE_BUILD_NUMBER.apk                         â•‘
            â•‘                                                              â•‘
            â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
            â•‘                      ğŸ”¥ FEATURES                             â•‘
            â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
            â•‘  â€¢ Firebase Authentication (Email/Password)                  â•‘
            â•‘  â€¢ Cloud Firestore database integration                     â•‘
            â•‘  â€¢ User profiles with customization                          â•‘
            â•‘  â€¢ Quote gallery and management                              â•‘
            â•‘  â€¢ Firebase Analytics tracking                               â•‘
            â•‘  â€¢ Firebase Crashlytics monitoring                           â•‘
            â•‘  â€¢ Material Design 3 UI                                      â•‘
            â•‘  â€¢ Dark/Light theme support                                  â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            EOF
            
            echo "âœ… Installation instructions created"
    
    # ========== STEP 12: Deploy Artifacts ==========
    - deploy-to-bitrise-io@2:
        title: Deploy build artifacts
        inputs:
        - notify_user_groups: none
        - is_compress: 'false'

# ============================================
# APP ENVIRONMENT VARIABLES
# ============================================
app:
  envs:
  - BITRISE_FLUTTER_PROJECT_LOCATION: "."
    opts:
      is_expand: false
  - FLUTTER_VERSION: stable
    opts:
      is_expand: false
